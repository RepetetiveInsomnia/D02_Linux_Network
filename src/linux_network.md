## Part1. Инструмент ipcalc

#### 1.1 Сети и маски

- ipcalc предоставляет простой метод для вычисления IP-информации хоста. Различные опции определяют, какую информацию ipcalc должен вывести на стандартный выход. Могут быть заданы несколько опций. Обрабатываемый IP-адрес всегда должен быть указан. Для большинства операций также требуется сетевая маска

- опции

- -b, Показывает широковещательный адрес для указанного IP-адреса и сетевой маски.
- -h, Показывает имя хоста указанного IP-адреса.
- -m, Вычисляет сетевую маску указанного IP-адреса. Подразумевается, что IP- адрес принадлежит полной сети класса A, B или C. Многие сети не используют сетевые маски по умолчанию, в данном случае будет возвращено недействительное значение.
- -p, Показывает префикс указанной маски/IP-адреса.
- -n, Показывает сетевой адрес указанного IP-адреса и сетевой маски.

- например:
- ![ipcalc a ws1](/src/network/task1/1.1.png)

- Адрес сети 192.167.38.54/13 - 196.160.0.0

- Маска 255.255.255.0 в префиксной(Netmask) - /24. В двоичной(без флага -b) - 11111111.11111110.11111111.00000000

- /15 в обычной записи(Adress) - 255.254.0.0. В двоичной - 11111111.11111110.00000000.00000000

- 11111111.11111111.11111111.11110000 в обычной(Adress) - 255.255.255.240. В префиксной(Netmask) - /28

- Подставляем маску, например:
- ![ipcalc/mask a ws1](/src/network/task1/1.2.png)

- Минимальный(hostmin) 12.167.38.5/8 - 12.0.0.1. Максимальный(hostmax) - 12.255.255.254. 
- Минимальный(hostmin) 12.167.38.4/255.255.0.0 - 12.167.0.0. Максимальный(hostmax) - 12.167.255.254. 
- Минимальный(hostmin) 12.167.38.5/255.255.254.0 - 12.167.38.1. Максимальный(hostmax) - 12.167.39.254.
- Минимальный(hostmin) 12.167.38.4/4 - 0.0.0.1. Мксимальный(hostmax) 15.255.255.254.

#### 1.2 localhost

- 10.0.0.0 — 10.255.255.255 (маска подсети для бесклассовой (CIDR) адресации: 255.0.0.0 или /8)
- 100.64.0.0 — 100.127.255.255 (маска подсети 255.192.0.0 или /10) - Данная подсеть рекомендована согласно RFC 6598 для использования в качестве адресов для CGN (Carrier-Grade NAT)
- 172.16.0.0 — 172.31.255.255 (маска подсети: 255.240.0.0 или /12)
- 192.168.0.0 — 192.168.255.255 (маска подсети: 255.255.0.0 или /16)
- Также для петлевых интерфейсов (не используется для обмена между узлами сети) зарезервирован диапазон 127.0.0.0 — 127.255.255.255 (маска подсети: 255.0.0.0 или /8).

- Смотрим на графу class и host/net, ищем loopback

- 194.34.23.100 - нет
127.0.0.2 - да(loopback)
127.1.0.1 - да(loopback)
128.0.0.1 - нет

#### 1.3. Диапазоны и сегменты сетей

- По аналогии смотрим на class и host/net

- Private internet: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255, 10.10.10.10
Public: 134.43.0.2, 172.0.2.1, 192.172.0.1, 172.68.0.2,192.169.168.1

- По аналогии смотрим на class и host/net

- У 10.10.0.0/18 hostmin - 10.10.0.1. hostmax - 10.10.63.254. 
Следовательно возможны: 10.10.0.2, 10.10.10.10, 10.10.1.255.
Невозможны: 10.0.0.0, 10.10.100.1.

## Part 2. Статическая маршрутизация между двумя машинами

- ip a для ws1!!!

![ip a ws1](/src/network/task2/2.2.png)

- ip a для ws2!!!

![ip a ws2](/src/network/task2/2.3.png)

- Измененный netplan ws1

![netplan ws1](/src/network/task2/2.4.png)

- Измененный netplan ws2

![netplan ws2](/src/network/task2/2.5.png)

#### 2.1. Добавление статического маршрута вручную

- Сначала добавим ip adress в ws1. sudo ip addr add 172.24.116.8/12 dev enp0s3. sudo ip r add 172.24.116.8 via 192.168.100.10 dev enp0s3

- ws1 Ping -c 3 172.24.116.8/12

![ws1->ws2](/src/network/task2/2.6.png)


- ws2 Ping -c 3 192.168.100.10/16

![ws2->ws1](/src/network/task2/2.7.png)

#### 2.2. Добавление статического маршрута с сохранением

- Перезпустил ws1 и ws2 и переписал netplan.

- ws1 -> ws2

![new_netplan ws1->ws2](/src/network/task2/2.8.png)

- ws2 -> ws1

![new_netplan ws2->ws1](/src/network/task2/2.9.png)

## Part3. Утилита iperf3

#### Part 3.1. Скорость соединения
- 8 Mbps = 1 MB/s. 100 MB/s = 800000 kbps. 1 Gbps = 100000 Mbps.
- Допустим ws1 сервер, запускаем команду iperf3 -s -f m
- Допустим ws2 гость, запускаем команду iperf3 -c 192.168.100.10
  
![ws1 iperf3](/src/network/task3/3.1.png)
![ws2 iperf3](/src/network/task3/3.2.png)

## Part4. Сетевой экран

#### Part4.1. Утилита iptables

nano /etc/firewall.sh
iptables -F. Очистка всех правил.
iptables -X. Удаление цепочки.
-A - добавление нового правила в цепочку.
-p - указание на протокол.
--ddport - указание порта (ssh)
-j - действие, если успешно

- firewall.sh на ws1 и ws2
  
- Вывод команд и содержимого firewall.sh на обеих машинах

![ws1 filewall.sh](/src/network/task4/4.1.png)
![ws2 filewall.sh](/src/network/task4/4.2.png)

#### Part 4.2. Утилита nmap

-Пингуем машины между собой чтобы проверить firewall

![ping ws1 -> ws2](/src/network/task4/4.3.png)
- Пинг произошел

![ping ws2 -> ws1](/src/network/task4/4.4.png)
- Пинг отсутсвует как для ws1 мы сначала написали запрещающее правило

- запускаем nmap
![nmap ws1](/src/network/task4/4.5.png)
- Видим что Host is up


## Part 5. Статическая маршрутизация сети

#### Part 5.1 Настройка адресов машин

- ws11 netplan

![ws11](/src/network/task5/5.1.1.png)

-r1 netplan

![r1](/src/network/task5/5.1.2.png)

-ws21 netplan

![ws21](/src/network/task5/5.1.3.png)

-ws22 netplan

![ws22](/src/network/task5/5.1.4.png)

-r2 netplan

![r2](/src/network/task5/5.1.5.png)

-проверка настройки адресов всех машин + ping

![all](/src/network/task5/5.1.6.png)

#### Part 5.2. Включение переадресации IP-адресов.

- Вызов команды sysctl -w net.ipv4.ip_forward=1 на роутерах

![sysctl](/src/network/task5/5.2.1.png)

- Изменение sysctl.conf r1 и r2

![confr1](/src/network/task5/5.2.2.png)


#### Part 5.3 Установка маршрута по-умолчанию

- Обратите внимание! set-name невозможно установить без прописывания mac адреса, его мы узнаем из настроек сети каждой из ВМ. Также было выбрано использовать вместо gateway4 routes, так как по заданию (To do this, add default before the router's IP in the configuration file)

- ws11 новый config и ip r

![ws11](/src/network/task5/5.3.1.png)

- ws21 новый config и ip r

![ws21](/src/network/task5/5.3.2.png)

- ws22 новый config и ip r

![ws22](/src/network/task5/5.3.3.png)

- Обратите внимание! при изменении конфига мы также затронули настройки портов ВМ для роутеров. для r1 адаптер 2 это LAN1, адаптер 3 это LAN2, для r2 наоборот.
- r1 новый config и ip r

![r1](/src/network/task5/5.test.png)
![r1.ipr](/src/network/task5/5.tets2.png)

- r2 новый config и ip r

![r2](/src/network/task5/5.3.5.png)

- ping ws11 и r2
- tcpdump (от TCP и англ. dump — свалка, сбрасывать) — утилита UNIX (есть клон для Windows), позволяющая перехватывать и анализировать сетевой трафик, проходящий через компьютер, на котором запущена данная программа. Ключ - i Указывает на то, какой сетевой интерфейс будет использоваться для захвата пакетов. По умолчанию — eth0, для выбора всех интерфейсов — any. Если отсутствует локальная сеть, то можно воспользоваться интерфейсом обратной связи lo. Ключ - n Отображает IP-адрес вместо имени хоста. Ключ - t Не отображает метку времени в каждой строке. Ключ - v Отображает IP-адрес вместо имени хоста. Ключ - v Вывод подробной информации (TTL; ID; общая длина заголовка, а также его параметры; производит проверку контрольных сумм IP и ICMP-заголовков)

![ping](/src/network/task5/5.3.6.png)

#### Part 5.4. Добавление статических маршрутов

- настройку статических маршрутов мы провели в предыдущем пункте

- ip r list 10.10.0.0/[маска сети(18)] и ip r list 0.0.0.0/0

![iprlist](/src/network/task5/5.4.1.png)

-маршрут по умолчанию (10.10.0.1) используется только тогда, когда у нас нет подходящих маршрутов. Ближайшим подходящим отказался (10.10.0.2). выбранный маршрут отличается от 0.0.0.0/0, так как  всегда выбирается  маршрут с самой длинной маской из-за опасности потери точности.

#### Part 5.5. Построение списка маршрутизаторов

- Запуск tcpdump -n -i eth0 icmp на r1 и traceroute на ws11

![traceroute](/src/network/task5/5.5.png)

- Traceroute — это служебная компьютерная программа, предназначенная для определения маршрутов следования данных в сетях TCP/IP.Для определения промежуточных маршрутизаторов traceroute отправляет целевому узлу серию ICMP-пакетов (по умолчанию 3 пакета), с каждым шагом увеличивая значение поля TTL («время жизни») на 1. Это поле обычно указывает максимальное количество маршрутизаторов, которое может быть пройдено пакетом. Первая серия пакетов отправляется с TTL, равным 1, и поэтому первый же маршрутизатор возвращает обратно ICMP-сообщение «time exceeded in transit», указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения выводятся на монитор компьютера). Затем traceroute повторяет отправку серии пакетов, но уже с TTL, равным 2, что заставляет первый маршрутизатор уменьшить TTL пакетов на единицу и направить их ко второму маршрутизатору. Второй маршрутизатор, получив пакеты с TTL=1, так же возвращает «time exceeded in transit».

- Процесс повторяется до тех пор, пока пакет не достигнет целевого узла. При получении ответа от этого узла процесс трассировки считается завершённым.

 #### Part 5.6. Использование протокола ICMP при маршрутизации

 - ICMP (англ. Internet Control Message Protocol — протокол межсетевых управляющих сообщений) — сетевой протокол, входящий в стек протоколов TCP/IP. В основном ICMP используется для передачи сообщений об ошибках и других исключительных ситуациях, возникших при передаче данных, например, запрашиваемая услуга недоступна или хост, или маршрутизатор не отвечают. 

![pingicmp](/src/network/task5/5.6.png)

- Сохраняем дамп ВМ 

![dump](/src/network/task5/5.0.png)

## Part 6. Динамическая настройка IP с помощью DHCP

- DHCP (англ. Dynamic Host Configuration Protocol — протокол динамической настройки узла) — сетевой протокол, позволяющий сетевым устройствам автоматически получать IP-адрес и другие параметры, необходимые для работы в сети TCP/IP. Данный протокол работает по модели «клиент-сервер». Для автоматической конфигурации компьютер-клиент на этапе конфигурации сетевого устройства обращается к так называемому серверу DHCP и получает от него нужные параметры. Сетевой администратор может задать диапазон адресов, распределяемых сервером среди компьютеров. Это позволяет избежать ручной настройки компьютеров сети и уменьшает количество ошибок.

- dhcpd.conf

![dhcpd](/src/network/task6/6.1.png)

- resolv.conf

![resolv](/src/network/task6/6.2.png)

- перезагрузка dhcp

![dhcpd-restart](/src/network/task6/6.2.1.png)

- reboot ws21
- sudo dhclient -r sudo dhclient eth0
- ip a ws21

![ipaws21](/src/network/task6/6.2.2.png)

- ping ws22 -> ws21

![ping](/src/network/task6/6.2.3.png)

- Новый конфиг r1 dhcpd.conf по аналогии

![r1](/src/network/task6/6.2.4.png)

- Новых config для ws11 с mac address

![mac](/src/network/task6/6.2.5.png)


- проверяем изменение в ws11
- ВАЖНО не забываем прописать mac адрес в настройках ВМ

![new_ws11](/src/network/task6/6.2.6.png)

- пингуем ws22
![ping_ws22](/src/network/task6/6.2.6.1.png)

- ws21 ip a до и после

![ws21before](/src/network/task6/6.2.7.png)

![ws21after](/src/network/task6/6.2.8.png)


## Part 7. 

- Изменяем r1 и ws22  /etc/apache2/ports.conf Listen 80 на Listen 0.0.0.0:80 и запускаем командой

![apache2](/src/network/task7/7.1.png)

- Изменяем firewall.sh
- Удаление правил в таблице filter - iptables -F
- Удаление правил в таблице "NAT" - iptables -F -t nat
- Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![fire1](/src/network/task7/7.2.png)

- Проверил соединение ws22->r1 (его нет)

![ping](/src/network/task7/7.3.png)

- Снова меняем firewall.sh и пингуем
- Разрешить маршрутизацию всех пакетов протокола ICMP

![fire2](/src/network/task7/7.4.png)

- Включил SNAT для сети 10.20.0.0 и DBAT на 8080 порт для r2

![fire3](/src/network/task7/7.5.png)

- telnet для проверки подключения к серверу для SNAT

![telnet_SNAT](/src/network/task7/7.6.png)

- telnet для проверки подключения к серверу для DNAT

![telnet](/src/network/task7/7.7.png)

## Part 8. Знакомство с SSH Tunnels

- Изменил apache2/ports.conf и запустил apache2

![apache2](/src/network/task8/8.1.png)

- netstat для ws21 до подключения(подключений нет) + команда для подключения

![netstat_ws21](/src/network/task8/8.2.1.png)

- после подключения видим через netstat что подключение состоялось

![connection_established](/src/network/task8/8.2.2.png)

- проверяем по telnet подключение к использованному нами порту 5555

![telnet_ws21](/src/network/task8/8.2.3.png)

- показываем, что на ws11 не запущен apache2 и его netstat

![netstat_ws11](/src/network/task8/8.2.4.png)

- пробразываем подключение к ws22 от ws11 исполняя команду на ws22

![ws11 -> ws22 -R](/src/network/task8/8.2.5.png)

- вызываем telnet на ws11 по использованному нами порту 4444 чтобы проверить соединение

![telnet_ws11](/src/network/task8/8.2.6.png)

- возвращаемся на ws22 и вызываем netplan, должно  быть два соединения

![final_netstat](/src/network/task8/8.2.7.png)

- зафиксировали что соединения два, их адреса соответсвуют адресам машин, с которых мы подключались

* почему мы не использовали telnet localhost 80 на ws22? ответ: так как мы установили прослушивание порта на локалхост 80 в настройках конфига, то вне зависимости от подключения эта команда выдавала бы положительный результат. Эта команда имеет смысл когда мы установили соединение по порту(например 5555) и вызываем ее для проверки. До установления соединения получить положительный результат от команды не получится, следовательно, только в таком случае мы можем проверить с помощью нее успешность соединения. В целом для этого таска удобнее использовать netstat. 
